# æ¨¡å—è‡ªåŠ¨åŠ è½½

## ä»“åº“

æ¨¡å—è‡ªåŠ¨åŠ è½½æ’ä»¶ `npm` åŒ…å·²å®ç°ï¼Œå…·ä½“å¯è§è¯¥ä»“åº“ ğŸ‘‰ [vite-plugin-use-modules](https://github.com/dishait/vite-plugin-use-modules)ã€‚

<br />
<br />

## åŸç†

### [Glob å¯¼å…¥](https://cn.vitejs.dev/guide/features.html#glob-import)

åœ¨ `vite` ä¸­æœ‰ä¸ªéå¸¸å¥½ç”¨çš„åŠŸèƒ½å«åš [Glob å¯¼å…¥](https://cn.vitejs.dev/guide/features.html#glob-import)ã€‚

ä¾‹å¦‚ä½ å¯ä»¥é€šè¿‡ä¸‹è¾¹çš„æ–¹å¼è‡ªåŠ¨å¼•å…¥ `src/modules` ä¸‹çš„æ‰€æœ‰ `js` æ¨¡å—

```js
const modules = import.meta.globEager(
	'/src/modules/**/*.js'
)

console.log(modules) // å°†ä»¥å¯¹è±¡çš„æ–¹å¼è¾“å‡ºåˆ°å‰ç«¯æ§åˆ¶å°
```

![Glob å¯¼å…¥](/quick/img/globEager.gif)

<br />
<br />

### è‡ªåŠ¨æ³¨å†Œ

æ ¹æ®ä¸Šè¾¹çš„åŸç†ï¼Œæˆ‘ä»¬å°±å¯ä»¥è‡ªåŠ¨æ³¨å†Œ `vue` æ¨¡å—

ä¾‹å¦‚æ³¨å†Œ `pinia`

<CodeGroup>
  <CodeGroupItem title="npm" active>

```shell
npm i pinia -D
```

  </CodeGroupItem>

  <CodeGroupItem title="yarn">

```shell
yarn add pinia -D
```

  </CodeGroupItem>

  <CodeGroupItem title="pnpm">

```shell
pnpm add pinia -D
```

  </CodeGroupItem>

</CodeGroup>

ç„¶ååˆ›å»ºæ¨¡å— `src/modules/pinia.js`

```js
// src/modules/pinia.js
import { createPinia } from 'pinia'

export default app => app.use(createPinia())
```

ç„¶ååœ¨ `src/main.js` ä¸‹ä¹¦å†™ä»¥ä¸‹ä»£ç 

```js
import App from './App.vue'
import { createApp } from 'vue'

const app = createApp(App)

// å¼•å…¥æ‰€æœ‰æ¨¡å—
const modules = import.meta.globEager(
	'/src/modules/**/*.js'
)
// å®‰è£…æ’ä»¶
Object.values(modules).forEach(module => {
	if (typeof module.default === 'function') {
		module.default(app)
	}
})

app.mount('#app')
```

ä»¥ä¸Šå°±ç®—è‡ªåŠ¨æ³¨å†Œ `pinia` æˆåŠŸäº†ï¼Œå¯ä»¥åˆ›å»º `src/stores/counter.js` éªŒè¯ä¸€ä¸‹

```js
// src/stores/counter.js
import { defineStore } from 'pinia'

export const useCounterStore = defineStore('counter', {
	state() {
		return {
			counter: 0
		}
	},
	actions: {
		inc() {
			this.counter++
		}
	}
})
```

æœ€åå°±å¯ä»¥åœ¨ `src/App.vue` ä¸­ä½¿ç”¨äº†

```html
<script setup>
	import { useCounterStore } from './stores/counter'

	const store = useCounterStore()
</script>

<template>
	<div @click="store.inc()">{{ store.counter }}</div>
</template>
```

![è‡ªåŠ¨æ³¨å†Œ](/quick/img/autoUse.gif)

<br />
<br />

### [è™šæ‹Ÿæ¨¡å—](https://cn.vitejs.dev/guide/api-plugin.html#importing-a-virtual-file)

æˆ‘ä»¬éƒ½çŸ¥é“ `vite` æ’ä»¶é‡Œæœ‰ä¸ªéå¸¸å¥½ç”¨çš„è™šæ‹Ÿæ–‡ä»¶æˆ–è€…è™šæ‹Ÿæ¨¡å—åŠŸèƒ½

ä¾‹å¦‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª `plugins/foo.js` æ’ä»¶

```js
// plugins/foo.js
// è™šæ‹Ÿæ¨¡å— id
const virtualModuleId = 'msg'
// å¤„ç†ä¹‹åçš„è™šæ‹Ÿæ¨¡å— id
const resolvedVirtualModuleId = '\0' + virtualModuleId
// è™šæ‹Ÿæ¨¡å—ä»£ç 
const code = `export default 100`

export default {
	name: 'foo',
	resolveId(id) {
		if (id === virtualModuleId) {
			return resolvedVirtualModuleId
		}
	},
	load(id) {
		if (id === resolvedVirtualModuleId) {
			return code
		}
	}
}
```

ç„¶åæˆ‘ä»¬éœ€è¦æ³¨å†Œè¯¥æ’ä»¶

```js
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import foo from './plugins/foo'

export default defineConfig({
	plugins: [vue(), foo]
})
```

æœ€åå°±å¯ä»¥åœ¨å‰ç«¯é‡Œå¼•å…¥è¯¥è™šæ‹Ÿæ¨¡å—äº†ï¼Œä¾‹å¦‚ `src/main.js` ä¸­

```js
// ...
import msg from 'msg'

console.log(msg) // å°†åœ¨å‰ç«¯æ§åˆ¶å°è¾“å‡º 100
// ...
```

![è™šæ‹Ÿæ¨¡å—](/quick/img/virtualModule.gif)

<br />
<br />
<br />

## å®ç°

åŒç†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ›å»ºæºå¸¦ [Glob å¯¼å…¥](https://cn.vitejs.dev/guide/features.html#glob-import) å®ç°è‡ªåŠ¨æ³¨å†Œ `vue` æ¨¡å—çš„ä»£ç 

é¦–å…ˆåˆ›å»º `plugins/use-modules.js` æ’ä»¶

```js
export default () => {
	const virtualModuleId = 'virtual:modules'
	const resolvedVirtualModuleId = '\0' + virtualModuleId

	const code = `
export const modules = import.meta.globEager(
    '/src/modules/**/*.js'
)

export const useModules = app => {
    Object.values(modules).forEach(module => {
        if (typeof module.default === 'function') {
            module.default(app)
        }
    })
}`

	return {
		name: 'vite-plugin-use-modules',
		resolveId(id) {
			if (id === virtualModuleId) {
				return resolvedVirtualModuleId
			}
		},
		load(id) {
			if (id === resolvedVirtualModuleId) {
				return code
			}
		}
	}
}
```

ç„¶åæ³¨å†Œä¸€ä¸‹æ’ä»¶

```js
// vite.config.js
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import Modules from './plugins/use-modules'

export default defineConfig({
	plugins: [vue(), Modules()]
})
```

æœ€åå°±å¯ä»¥åœ¨ `main.js` ä¸­æ„‰å¿«çš„ä½¿ç”¨æ¨¡å—è‡ªåŠ¨åŠ è½½äº†

```js
import App from './App.vue'
import { createApp } from 'vue'
import { useModules } from 'virtual:modules'

const app = createApp(App)

useModules(app)

app.mount('#app')
```

![å®ç°](/quick/img/useModules.gif)
